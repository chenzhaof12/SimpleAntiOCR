<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<title>ANTI TEXT DETECTIVE</title>
	<script type="text/javascript" src="jimp.min.js"></script>
</head>
<body>
	<input type="file" id="upload" accept="image/png, image/jpeg" onchange="getImageData();">
	<img id="preview" width="50%" style="display: none;">
	<!-- <img id="grey" width="50%" style="display: none;"> -->
	
</body>
<script type="text/javascript">
	var imgDom = document.getElementById("preview")
	var greyImg = document.getElementById("grey");
	// 默认配色
	// todo : 自己调色设置，文字生成图片，照片校正等 
	var blueFactor = 0.114;
	var redFactor = 0.299;
	var greenFactor = 0.587;
	

	var urlData;
	imgDom.onload = function(){
		imgDom.style.display = 'block';
	}
	// greyImg.onload = function(){
	// 	greyImg.style.display = 'block';
	// }
	// 二值化阈值
	var threshold =160

	function getImageData() {
		var resultFile = document.getElementById("upload").files[0];
        if (resultFile) {
            var reader = new FileReader();
            //异步方式，不会影响主线程
            reader.readAsArrayBuffer(resultFile);

            reader.onload = function(e) {
                urlData = e.target.result;
                dealImg()
            };
        }


	}

   	function dealImg(redValue, blueValue){
   		//水平投影结果
		var horPrj = []
		//间距高度阈值
		var textMinHeight = 3
		Jimp.read(urlData).then(image => {
			var index = 0
			var temSum = 0
			image.greyscale()
			.scan(0, 0, image.bitmap.width, image.bitmap.height, function(x, y, idx) {
				if(y!=index){
					horPrj.push(temSum)
					index = y;
					temSum = 0
				}
				//水平投影统计+二值化换色
				if(this.bitmap.data[idx]<threshold){
					temSum += 1
					this.bitmap.data[idx] = 255
					this.bitmap.data[idx+1] = 0
					this.bitmap.data[idx+2] = 0
				}else{
					this.bitmap.data[idx] = 76
					this.bitmap.data[idx+1] = 77
					this.bitmap.data[idx+2] = 76
				}
			})
			var len_hp = horPrj.length;
			var temHeight = 0
			for(var i=0;i<len_hp;i++){
				if(horPrj[i]==0){
					temHeight += 1
				}else{
					if(temHeight>textMinHeight){
						//上一段高度没有文字，反转干扰
						var imgTextCopy = image.clone()
						imgTextCopy.crop( 5, i-temHeight, imgTextCopy.bitmap.width-10, temHeight ).invert();
						image.blit(imgTextCopy, 5, i-temHeight);
					}
					temHeight = 0
				}
			}

			image.getBase64(Jimp.MIME_JPEG, function(err, src){
				imgDom.setAttribute("src", src);
			});
			//Jimp的灰度加权算法（查自源码）0.2126 *R + 0.7152 * G + 0.0722 * B, 与opencv有区别
			// image.greyscale().getBase64(Jimp.MIME_JPEG, function(err, src){
			// 	greyImg.setAttribute("src", src);
			// });
		})
		.catch(err => {
		// Handle an exception.
			alert('出错啦！比较可能是浏览器不支持')
		});
   	}
	

</script>
</html>